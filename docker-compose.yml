# Docker Compose for Local Development

services:
  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8001:8000"
    environment:
      - ENVIRONMENT=development
      - LOG_LEVEL=debug
      - REDIS_URL=redis://redis:6379
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=devpassword
      - CHROMADB_HOST=chromadb
      - CHROMADB_PORT=8000
      - DATABASE_URL=postgresql+asyncpg://user:password@db:5432/dcis
      - POSTGRES_HOST=db
      - POSTGRES_PORT=5432
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=dcis
    volumes:
      - ./backend:/app
      - ./backend/config:/app/config
    depends_on:
      - redis
      - neo4j
      - chromadb
      - db
    networks:
      - dcis-network
    restart: unless-stopped

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    ports:
      - "3001:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8001
      - NEXT_PUBLIC_WS_URL=ws://localhost:8001/ws
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    depends_on:
      - backend
    networks:
      - dcis-network
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    ports:
      - "6380:6379"
    volumes:
      - redis-data:/data
    networks:
      - dcis-network
    restart: unless-stopped

  # PostgreSQL
  db:
    image: postgres:15-alpine
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=dcis
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - dcis-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U user -d dcis" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # Neo4j
  neo4j:
    image: neo4j:5.13-community
    ports:
      - "7475:7474" # HTTP browser
      - "7688:7687" # Bolt
    environment:
      - NEO4J_AUTH=neo4j/devpassword
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    networks:
      - dcis-network
    restart: unless-stopped

  # ChromaDB
  chromadb:
    image: chromadb/chroma:latest
    ports:
      - "8002:8000"
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/data
    volumes:
      - chromadb-data:/chroma/data
    networks:
      - dcis-network
    restart: unless-stopped

volumes:
  redis-data:
  postgres-data:
  neo4j-data:
  neo4j-logs:
  chromadb-data:


networks:
  dcis-network:
    driver: bridge
